tosca_definitions_version: alien_dsl_2_0_0

metadata:
  template_name: ConsulMultiDC
  template_version: 0.1.0-SNAPSHOT
  template_author: admin

description: >
  This topology demonstrate how to deploy 2 different Consul Data Centers (dc1 and dc2) on isolated networks
  and bind them using their WAN interface.

imports:
  - tosca-normative-types:1.0.0-ALIEN20SM5
  - janus-types:1.0.0
  - org.janus.samples.consul.linux.ansible:1.0.0-SNAPSHOT
  - org.janus.samples.consul.pub:1.0.0-SNAPSHOT

topology_template:
  node_templates:
    PublicNetwork:
      metadata:
        a4c_edit_x: 54
        a4c_edit_y: "-29"
      type: tosca.nodes.Network
      properties:
        ip_version: 4
    AppNetworkDC1:
      metadata:
        a4c_edit_x: "-368"
        a4c_edit_y: "-201"
      type: tosca.nodes.Network
      properties:
        ip_version: 4
        cidr: "10.1.2.0/24"
        network_name: AppNetDC1
    ComputeCADC1:
      metadata:
        a4c_edit_x: "-237"
        a4c_edit_y: "-3"
      type: tosca.nodes.Compute
      requirements:
        - networkPublicNetworkConnection:
            type_requirement: network
            node: PublicNetwork
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
        - networkAppNetworkConnection:
            type_requirement: network
            node: AppNetworkDC1
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 10
            default_instances: 2
        endpoint:
          properties:
            secure: true
            protocol: tcp
            network_name: PRIVATE
            initiator: source
    ComputeCSDC1:
      metadata:
        a4c_edit_x: 37
        a4c_edit_y: "-5"
      type: tosca.nodes.Compute
      requirements:
        - networkNetworkConnection:
            type_requirement: network
            node: PublicNetwork
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
        - networkAppNetworkConnection:
            type_requirement: network
            node: AppNetworkDC1
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 7
            default_instances: 3
        endpoint:
          properties:
            secure: true
            protocol: tcp
            network_name: PRIVATE
            initiator: source
    ConsulAgentDC1:
      type: org.janus.samples.consul.linux.ansible.nodes.ConsulAgent
      properties:
        install_dnsmasq: true
        mode: agent
        download_url: "https://releases.hashicorp.com/consul/1.0.2/consul_1.0.2_linux_amd64.zip"
        install_dir: "/usr/local/bin"
        data_dir: "/var/consul"
        config_dir: "/etc/consul.d"
        datacenter: dc1
        domain: consul
      requirements:
        - joinServerConsulServerConsul_server:
            type_requirement: consul_server
            node: ConsulServerDC1
            capability: org.janus.samples.consul.pub.capabilities.ConsulServer
            relationship: org.janus.samples.consul.linux.ansible.relationships.JoinServer
        - hostedOnComputeCaHost:
            type_requirement: host
            node: ComputeCADC1
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
      capabilities:
        consul_agent:
          properties:
            api_port: 8500
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
    ConsulServerDC1:
      type: org.janus.samples.consul.linux.ansible.nodes.ConsulServer
      properties:
        install_dnsmasq: true
        mode: server
        download_url: "https://releases.hashicorp.com/consul/1.0.2/consul_1.0.2_linux_amd64.zip"
        install_dir: "/usr/local/bin"
        data_dir: "/var/consul"
        config_dir: "/etc/consul.d"
        datacenter: dc1
        domain: consul
      requirements:
        - hostedOnComputeHost:
            type_requirement: host
            node: ComputeCSDC1
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - joinServerWanConsulServerDc2Join_wan:
            type_requirement: wan_server
            node: ConsulServerDC2
            capability: org.janus.samples.consul.pub.capabilities.ConsulServerWAN
            relationship: org.janus.samples.consul.linux.ansible.relationships.JoinServerWAN
      capabilities:
        consul_agent:
          properties:
            api_port: 8500
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
    AppNetworkDC2:
      metadata:
        a4c_edit_x: "-247"
        a4c_edit_y: "-208"
      type: tosca.nodes.Network
      properties:
        ip_version: 4
        cidr: "10.1.1.0/24"
        network_name: AppNetDC2
    ComputeCSDC2:
      metadata:
        a4c_edit_x: 609
        a4c_edit_y: 22
      type: tosca.nodes.Compute
      requirements:
        - networkPublicNetworkConnection:
            type_requirement: network
            node: PublicNetwork
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
        - networkAppNetworkDc2Connection:
            type_requirement: network
            node: AppNetworkDC2
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 10
            default_instances: 3
        endpoint:
          properties:
            secure: true
            protocol: tcp
            network_name: PRIVATE
            initiator: source
    ComputeCADC2:
      metadata:
        a4c_edit_x: 313
        a4c_edit_y: 130
      type: tosca.nodes.Compute
      requirements:
        - networkPublicNetworkConnection:
            type_requirement: network
            node: PublicNetwork
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
        - networkAppNetworkDc2Connection:
            type_requirement: network
            node: AppNetworkDC2
            capability: tosca.capabilities.Connectivity
            relationship: tosca.relationships.Network
      capabilities:
        scalable:
          properties:
            min_instances: 1
            max_instances: 10
            default_instances: 2
        endpoint:
          properties:
            secure: true
            protocol: tcp
            network_name: PRIVATE
            initiator: source
    ConsulServerDC2:
      type: org.janus.samples.consul.linux.ansible.nodes.ConsulServer
      properties:
        install_dnsmasq: true
        mode: server
        download_url: "https://releases.hashicorp.com/consul/1.0.2/consul_1.0.2_linux_amd64.zip"
        install_dir: "/usr/local/bin"
        data_dir: "/var/consul"
        config_dir: "/etc/consul.d"
        datacenter: dc2
        domain: consul
      requirements:
        - hostedOnComputeCsdc2Host:
            type_requirement: host
            node: ComputeCSDC2
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
      capabilities:
        consul_agent:
          properties:
            api_port: 8500
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
    ConsulAgentDC2:
      type: org.janus.samples.consul.linux.ansible.nodes.ConsulAgent
      properties:
        install_dnsmasq: true
        mode: agent
        download_url: "https://releases.hashicorp.com/consul/1.0.2/consul_1.0.2_linux_amd64.zip"
        install_dir: "/usr/local/bin"
        data_dir: "/var/consul"
        config_dir: "/etc/consul.d"
        datacenter: dc2
        domain: consul
      requirements:
        - hostedOnComputeCadc2Host:
            type_requirement: host
            node: ComputeCADC2
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - joinServerConsulServerDc2Consul_server:
            type_requirement: consul_server
            node: ConsulServerDC2
            capability: org.janus.samples.consul.pub.capabilities.ConsulServer
            relationship: org.janus.samples.consul.linux.ansible.relationships.JoinServer
      capabilities:
        consul_agent:
          properties:
            api_port: 8500
            protocol: tcp
            secure: false
            network_name: PRIVATE
            initiator: source
  workflows:
    install:
      steps:
        Compute_install:
          target: ComputeCSDC1
          activities:
            - delegate: install
          on_success:
            - ConsulServer_initial
        ConsulServer_initial:
          target: ConsulServerDC1
          activities:
            - set_state: initial
          on_success:
            - ConsulServer_creating
        ConsulServer_creating:
          target: ConsulServerDC1
          activities:
            - set_state: creating
          on_success:
            - ConsulServer_create
        ConsulServer_created:
          target: ConsulServerDC1
          activities:
            - set_state: created
          on_success:
            - ConsulServer_configuring
        ConsulServer_configuring:
          target: ConsulServerDC1
          activities:
            - set_state: configuring
          on_success:
            - ConsulServer_hostedOnComputeHost_pre_configure_source
            - ConsulAgent_joinServerConsulServerConsul_server_pre_configure_target
            - ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_pre_configure_source
            - ConsulServer_configure
        ConsulServer_configured:
          target: ConsulServerDC1
          activities:
            - set_state: configured
          on_success:
            - ConsulServer_starting
        ConsulServer_starting:
          target: ConsulServerDC1
          activities:
            - set_state: starting
          on_success:
            - ConsulServer_start
        ConsulServer_started:
          target: ConsulServerDC1
          activities:
            - set_state: started
          on_success:
            - ConsulServer_hostedOnComputeHost_add_target
            - ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_add_source
            - ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_add_target
            - ConsulAgent_initial
        ConsulServer_create:
          target: ConsulServerDC1
          activities:
            - call_operation: Standard.create
          on_success:
            - ConsulServer_created
        ConsulServer_configure:
          target: ConsulServerDC1
          activities:
            - call_operation: Standard.configure
          on_success:
            - ConsulServer_hostedOnComputeHost_post_configure_source
            - ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_post_configure_source
            - ConsulServer_configured
            - ConsulAgent_joinServerConsulServerConsul_server_post_configure_target
        ConsulServer_start:
          target: ConsulServerDC1
          activities:
            - call_operation: Standard.start
          on_success:
            - ConsulServer_started
        ConsulServer_hostedOnComputeHost_pre_configure_source:
          target: ConsulServerDC1
          target_relationship: hostedOnComputeHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulServer_configure
        ConsulServer_hostedOnComputeHost_post_configure_source:
          target: ConsulServerDC1
          target_relationship: hostedOnComputeHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulServer_configured
        ConsulServer_hostedOnComputeHost_add_target:
          target: ConsulServerDC1
          target_relationship: hostedOnComputeHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
        Network_install:
          target: PublicNetwork
          activities:
            - delegate: install
          on_success:
            - Compute_install
            - Compute_install_1
            - Compute_install_2
            - Compute_2_install
        Compute_install_1:
          target: ComputeCADC1
          activities:
            - delegate: install
          on_success:
            - ConsulAgent_initial
        ConsulAgent_initial:
          target: ConsulAgentDC1
          activities:
            - set_state: initial
          on_success:
            - ConsulAgent_creating
        ConsulAgent_creating:
          target: ConsulAgentDC1
          activities:
            - set_state: creating
          on_success:
            - ConsulAgent_create
        ConsulAgent_created:
          target: ConsulAgentDC1
          activities:
            - set_state: created
          on_success:
            - ConsulAgent_configuring
        ConsulAgent_configuring:
          target: ConsulAgentDC1
          activities:
            - set_state: configuring
          on_success:
            - ConsulAgent_configure
            - ConsulAgent_hostedOnComputeCaHost_pre_configure_source
            - ConsulAgent_joinServerConsulServerConsul_server_pre_configure_source
        ConsulAgent_configured:
          target: ConsulAgentDC1
          activities:
            - set_state: configured
          on_success:
            - ConsulAgent_starting
        ConsulAgent_starting:
          target: ConsulAgentDC1
          activities:
            - set_state: starting
          on_success:
            - ConsulAgent_start
        ConsulAgent_started:
          target: ConsulAgentDC1
          activities:
            - set_state: started
          on_success:
            - ConsulAgent_joinServerConsulServerConsul_server_add_target
            - ConsulAgent_hostedOnComputeCaHost_add_target
            - ConsulAgent_joinServerConsulServerConsul_server_add_source
        ConsulAgent_create:
          target: ConsulAgentDC1
          activities:
            - call_operation: Standard.create
          on_success:
            - ConsulAgent_created
        ConsulAgent_configure:
          target: ConsulAgentDC1
          activities:
            - call_operation: Standard.configure
          on_success:
            - ConsulAgent_joinServerConsulServerConsul_server_post_configure_source
            - ConsulAgent_configured
            - ConsulAgent_hostedOnComputeCaHost_post_configure_source
        ConsulAgent_start:
          target: ConsulAgentDC1
          activities:
            - call_operation: Standard.start
          on_success:
            - ConsulAgent_started
        ConsulAgent_hostedOnComputeCaHost_pre_configure_source:
          target: ConsulAgentDC1
          target_relationship: hostedOnComputeCaHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulAgent_configure
        ConsulAgent_hostedOnComputeCaHost_post_configure_source:
          target: ConsulAgentDC1
          target_relationship: hostedOnComputeCaHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulAgent_configured
        ConsulAgent_hostedOnComputeCaHost_add_target:
          target: ConsulAgentDC1
          target_relationship: hostedOnComputeCaHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
        ConsulAgent_joinServerConsulServerConsul_server_pre_configure_source:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulAgent_configure
        ConsulAgent_joinServerConsulServerConsul_server_pre_configure_target:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.pre_configure_target
          on_success:
            - ConsulServer_configure
        ConsulAgent_joinServerConsulServerConsul_server_post_configure_source:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulAgent_configured
        ConsulAgent_joinServerConsulServerConsul_server_post_configure_target:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.post_configure_target
          on_success:
            - ConsulServer_configured
        ConsulAgent_joinServerConsulServerConsul_server_add_source:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.add_source
        ConsulAgent_joinServerConsulServerConsul_server_add_target:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
        Network_install_1:
          target: AppNetworkDC1
          activities:
            - delegate: install
          on_success:
            - Compute_install
            - Compute_install_1
        Network_install_2:
          target: AppNetworkDC2
          activities:
            - delegate: install
          on_success:
            - Compute_install_2
            - Compute_2_install
        Compute_install_2:
          target: ComputeCSDC2
          activities:
            - delegate: install
          on_success:
            - ConsulServer_initial_1
        Compute_2_install:
          target: ComputeCADC2
          activities:
            - delegate: install
          on_success:
            - ConsulAgent_initial_1
        ConsulServer_initial_1:
          target: ConsulServerDC2
          activities:
            - set_state: initial
          on_success:
            - ConsulServer_creating_1
        ConsulServer_creating_1:
          target: ConsulServerDC2
          activities:
            - set_state: creating
          on_success:
            - ConsulServer_create_1
        ConsulServer_created_1:
          target: ConsulServerDC2
          activities:
            - set_state: created
          on_success:
            - ConsulServer_configuring_1
        ConsulServer_configuring_1:
          target: ConsulServerDC2
          activities:
            - set_state: configuring
          on_success:
            - ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_pre_configure_target
            - ConsulServer_configure_1
            - ConsulServer_hostedOnComputeCsdc2Host_pre_configure_source
            - ConsulAgentDC2_joinServerConsulServerDc2Consul_server_pre_configure_target
        ConsulServer_configured_1:
          target: ConsulServerDC2
          activities:
            - set_state: configured
          on_success:
            - ConsulServer_starting_1
        ConsulServer_starting_1:
          target: ConsulServerDC2
          activities:
            - set_state: starting
          on_success:
            - ConsulServer_start_1
        ConsulServer_started_1:
          target: ConsulServerDC2
          activities:
            - set_state: started
          on_success:
            - ConsulServer_hostedOnComputeCsdc2Host_add_target
            - ConsulAgent_initial_1
            - ConsulServer_initial
        ConsulServer_create_1:
          target: ConsulServerDC2
          activities:
            - call_operation: Standard.create
          on_success:
            - ConsulServer_created_1
        ConsulServer_configure_1:
          target: ConsulServerDC2
          activities:
            - call_operation: Standard.configure
          on_success:
            - ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_post_configure_target
            - ConsulAgentDC2_joinServerConsulServerDc2Consul_server_post_configure_target
            - ConsulServer_configured_1
            - ConsulServer_hostedOnComputeCsdc2Host_post_configure_source
        ConsulServer_start_1:
          target: ConsulServerDC2
          activities:
            - call_operation: Standard.start
          on_success:
            - ConsulServer_started_1
        ConsulServer_hostedOnComputeCsdc2Host_pre_configure_source:
          target: ConsulServerDC2
          target_relationship: hostedOnComputeCsdc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulServer_configure_1
        ConsulServer_hostedOnComputeCsdc2Host_post_configure_source:
          target: ConsulServerDC2
          target_relationship: hostedOnComputeCsdc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulServer_configured_1
        ConsulServer_hostedOnComputeCsdc2Host_add_target:
          target: ConsulServerDC2
          target_relationship: hostedOnComputeCsdc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
        ConsulAgent_initial_1:
          target: ConsulAgentDC2
          activities:
            - set_state: initial
          on_success:
            - ConsulAgent_creating_1
        ConsulAgent_creating_1:
          target: ConsulAgentDC2
          activities:
            - set_state: creating
          on_success:
            - ConsulAgent_create_1
        ConsulAgent_created_1:
          target: ConsulAgentDC2
          activities:
            - set_state: created
          on_success:
            - ConsulAgent_configuring_1
        ConsulAgent_configuring_1:
          target: ConsulAgentDC2
          activities:
            - set_state: configuring
          on_success:
            - ConsulAgent_hostedOnComputeCadc2Host_pre_configure_source
            - ConsulAgentDC2_joinServerConsulServerDc2Consul_server_pre_configure_source
            - ConsulAgent_configure_1
        ConsulAgent_configured_1:
          target: ConsulAgentDC2
          activities:
            - set_state: configured
          on_success:
            - ConsulAgent_starting_1
        ConsulAgent_starting_1:
          target: ConsulAgentDC2
          activities:
            - set_state: starting
          on_success:
            - ConsulAgent_start_1
        ConsulAgent_started_1:
          target: ConsulAgentDC2
          activities:
            - set_state: started
          on_success:
            - ConsulAgentDC2_joinServerConsulServerDc2Consul_server_add_target
            - ConsulAgent_hostedOnComputeCadc2Host_add_target
            - ConsulAgentDC2_joinServerConsulServerDc2Consul_server_add_source
        ConsulAgent_create_1:
          target: ConsulAgentDC2
          activities:
            - call_operation: Standard.create
          on_success:
            - ConsulAgent_created_1
        ConsulAgent_configure_1:
          target: ConsulAgentDC2
          activities:
            - call_operation: Standard.configure
          on_success:
            - ConsulAgent_hostedOnComputeCadc2Host_post_configure_source
            - ConsulAgentDC2_joinServerConsulServerDc2Consul_server_post_configure_source
            - ConsulAgent_configured_1
        ConsulAgent_start_1:
          target: ConsulAgentDC2
          activities:
            - call_operation: Standard.start
          on_success:
            - ConsulAgent_started_1
        ConsulAgent_hostedOnComputeCadc2Host_pre_configure_source:
          target: ConsulAgentDC2
          target_relationship: hostedOnComputeCadc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulAgent_configure_1
        ConsulAgent_hostedOnComputeCadc2Host_post_configure_source:
          target: ConsulAgentDC2
          target_relationship: hostedOnComputeCadc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulAgent_configured_1
        ConsulAgent_hostedOnComputeCadc2Host_add_target:
          target: ConsulAgentDC2
          target_relationship: hostedOnComputeCadc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_pre_configure_source:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulAgent_configure_1
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_pre_configure_target:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.pre_configure_target
          on_success:
            - ConsulServer_configure_1
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_post_configure_source:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulAgent_configured_1
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_post_configure_target:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.post_configure_target
          on_success:
            - ConsulServer_configured_1
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_add_source:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.add_source
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_add_target:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_pre_configure_source:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: SOURCE
          activities:
            - call_operation: Configure.pre_configure_source
          on_success:
            - ConsulServer_configure
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_pre_configure_target:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: TARGET
          activities:
            - call_operation: Configure.pre_configure_target
          on_success:
            - ConsulServer_configure_1
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_post_configure_source:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: SOURCE
          activities:
            - call_operation: Configure.post_configure_source
          on_success:
            - ConsulServer_configured
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_post_configure_target:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: TARGET
          activities:
            - call_operation: Configure.post_configure_target
          on_success:
            - ConsulServer_configured_1
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_add_source:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: TARGET
          activities:
            - call_operation: Configure.add_source
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_add_target:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: SOURCE
          activities:
            - call_operation: Configure.add_target
    uninstall:
      steps:
        Compute_uninstall:
          target: ComputeCSDC1
          activities:
            - delegate: uninstall
          on_success:
            - Network_uninstall_1
            - Network_uninstall
        ConsulServer_stopping:
          target: ConsulServerDC1
          activities:
            - set_state: stopping
          on_success:
            - ConsulServer_stop
        ConsulServer_stopped:
          target: ConsulServerDC1
          activities:
            - set_state: stopped
          on_success:
            - ConsulServer_deleting
        ConsulServer_deleting:
          target: ConsulServerDC1
          activities:
            - set_state: deleting
          on_success:
            - ConsulServer_delete
        ConsulServer_deleted:
          target: ConsulServerDC1
          activities:
            - set_state: deleted
          on_success:
            - Compute_uninstall
            - ConsulServer_stopping_1
        ConsulServer_stop:
          target: ConsulServerDC1
          activities:
            - call_operation: Standard.stop
          on_success:
            - ConsulServer_stopped
        ConsulServer_delete:
          target: ConsulServerDC1
          activities:
            - call_operation: Standard.delete
          on_success:
            - ConsulServer_deleted
        ConsulServer_hostedOnComputeHost_remove_target:
          target: ConsulServerDC1
          target_relationship: hostedOnComputeHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulServer_stopping
        Network_uninstall:
          target: PublicNetwork
          activities:
            - delegate: uninstall
        Compute_uninstall_1:
          target: ComputeCADC1
          activities:
            - delegate: uninstall
          on_success:
            - Network_uninstall_1
            - Network_uninstall
        ConsulAgent_stopping:
          target: ConsulAgentDC1
          activities:
            - set_state: stopping
          on_success:
            - ConsulAgent_stop
        ConsulAgent_stopped:
          target: ConsulAgentDC1
          activities:
            - set_state: stopped
          on_success:
            - ConsulAgent_deleting
        ConsulAgent_deleting:
          target: ConsulAgentDC1
          activities:
            - set_state: deleting
          on_success:
            - ConsulAgent_delete
        ConsulAgent_deleted:
          target: ConsulAgentDC1
          activities:
            - set_state: deleted
          on_success:
            - ConsulServer_stopping
            - Compute_uninstall_1
        ConsulAgent_stop:
          target: ConsulAgentDC1
          activities:
            - call_operation: Standard.stop
          on_success:
            - ConsulAgent_stopped
        ConsulAgent_delete:
          target: ConsulAgentDC1
          activities:
            - call_operation: Standard.delete
          on_success:
            - ConsulAgent_deleted
        ConsulAgent_hostedOnComputeCaHost_remove_target:
          target: ConsulAgentDC1
          target_relationship: hostedOnComputeCaHost
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulAgent_stopping
        ConsulAgent_joinServerConsulServerConsul_server_remove_source:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.remove_source
          on_success:
            - ConsulAgent_stopping
        ConsulAgent_joinServerConsulServerConsul_server_remove_target:
          target: ConsulAgentDC1
          target_relationship: joinServerConsulServerConsul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulAgent_stopping
        Network_uninstall_1:
          target: AppNetworkDC1
          activities:
            - delegate: uninstall
        Network_uninstall_2:
          target: AppNetworkDC2
          activities:
            - delegate: uninstall
        Compute_uninstall_2:
          target: ComputeCSDC2
          activities:
            - delegate: uninstall
          on_success:
            - Network_uninstall_2
            - Network_uninstall
        Compute_2_uninstall:
          target: ComputeCADC2
          activities:
            - delegate: uninstall
          on_success:
            - Network_uninstall_2
            - Network_uninstall
        ConsulServer_stopping_1:
          target: ConsulServerDC2
          activities:
            - set_state: stopping
          on_success:
            - ConsulServer_stop_1
        ConsulServer_stopped_1:
          target: ConsulServerDC2
          activities:
            - set_state: stopped
          on_success:
            - ConsulServer_deleting_1
        ConsulServer_deleting_1:
          target: ConsulServerDC2
          activities:
            - set_state: deleting
          on_success:
            - ConsulServer_delete_1
        ConsulServer_deleted_1:
          target: ConsulServerDC2
          activities:
            - set_state: deleted
          on_success:
            - Compute_uninstall_2
        ConsulServer_stop_1:
          target: ConsulServerDC2
          activities:
            - call_operation: Standard.stop
          on_success:
            - ConsulServer_stopped_1
        ConsulServer_delete_1:
          target: ConsulServerDC2
          activities:
            - call_operation: Standard.delete
          on_success:
            - ConsulServer_deleted_1
        ConsulServer_hostedOnComputeCsdc2Host_remove_target:
          target: ConsulServerDC2
          target_relationship: hostedOnComputeCsdc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulServer_stopping_1
        ConsulAgent_stopping_1:
          target: ConsulAgentDC2
          activities:
            - set_state: stopping
          on_success:
            - ConsulAgent_stop_1
        ConsulAgent_stopped_1:
          target: ConsulAgentDC2
          activities:
            - set_state: stopped
          on_success:
            - ConsulAgent_deleting_1
        ConsulAgent_deleting_1:
          target: ConsulAgentDC2
          activities:
            - set_state: deleting
          on_success:
            - ConsulAgent_delete_1
        ConsulAgent_deleted_1:
          target: ConsulAgentDC2
          activities:
            - set_state: deleted
          on_success:
            - ConsulServer_stopping_1
            - Compute_2_uninstall
        ConsulAgent_stop_1:
          target: ConsulAgentDC2
          activities:
            - call_operation: Standard.stop
          on_success:
            - ConsulAgent_stopped_1
        ConsulAgent_delete_1:
          target: ConsulAgentDC2
          activities:
            - call_operation: Standard.delete
          on_success:
            - ConsulAgent_deleted_1
        ConsulAgent_hostedOnComputeCadc2Host_remove_target:
          target: ConsulAgentDC2
          target_relationship: hostedOnComputeCadc2Host
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulAgent_stopping_1
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_remove_source:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: TARGET
          activities:
            - call_operation: Configure.remove_source
          on_success:
            - ConsulAgent_stopping_1
        ConsulAgentDC2_joinServerConsulServerDc2Consul_server_remove_target:
          target: ConsulAgentDC2
          target_relationship: joinServerConsulServerDc2Consul_server
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulAgent_stopping_1
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_remove_source:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: TARGET
          activities:
            - call_operation: Configure.remove_source
          on_success:
            - ConsulServer_stopping
        ConsulServerDC1_joinServerWanConsulServerDc2Join_wan_remove_target:
          target: ConsulServerDC1
          target_relationship: joinServerWanConsulServerDc2Join_wan
          operation_host: SOURCE
          activities:
            - call_operation: Configure.remove_target
          on_success:
            - ConsulServer_stopping
